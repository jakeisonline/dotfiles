#!/bin/bash

brew_installed=

# Check we have Homebrew, otherwise install it
{
  echo "Checking installed Homebrew version..." &&
  brew --version
  brew_installed=true
} || {
  echo "Failed to find Homebrew installed, installing..." &&
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  brew_installed=false
}

if [ $brew_installed ] ; then
  echo "Attempting to update Homebrew..."
  brew update
  echo "Attempting to update existing brews..."
  brew upgrade
fi;

function check_or_install_formulae() {
  installed_version=$(brew list --versions | grep $1 | cut -d " " -f 2)
  if [ ! "$installed_version" ] ; then
    echo "Attempting to install $1..." &&
    if [ $2 ] ; then
      brew install --cask $1
    else
      brew install $1
    fi;
  else
    echo "$1 already installed (v$installed_version)"
  fi;
}

# Install brews
check_or_install_formulae "git"
check_or_install_formulae "fzf"
check_or_install_formulae "node"
check_or_install_formulae "nvm"
check_or_install_formulae "pnpm"
check_or_install_formulae "pyenv"
check_or_install_formulae "pipenv"
check_or_install_formulae "zsh"
check_or_install_formulae "powerlevel10k"
check_or_install_formulae "stow"
check_or_install_formulae "zsh-autosuggestions"
check_or_install_formulae "bash"
check_or_install_formulae "bash-completion"
check_or_install_formulae "mas"
check_or_install_formulae "mysql" && brew services start mysql

# Install casks
check_or_install_formulae "logitech-options" true
check_or_install_formulae "arc" true
check_or_install_formulae "alfred" true
check_or_install_formulae "iterm2" true
check_or_install_formulae "font-monaspace" true
check_or_install_formulae "firefox" true
check_or_install_formulae "google-chrome" true
check_or_install_formulae "visual-studio-code" true
check_or_install_formulae "google-cloud-sdk" true
check_or_install_formulae "spotify" true

echo "Switching to updated bash..."
# Switch to using brew-installed bash as default shell
if ! fgrep -q "${BREW_PREFIX}/bin/bash" /etc/shells; then
  echo "${BREW_PREFIX}/bin/bash" | sudo tee -a /etc/shells;
  chsh -s "${BREW_PREFIX}/bin/bash";
fi;

unset check_or_install_formulae;
